"use strict";(self.webpackChunkcardano_updates=self.webpackChunkcardano_updates||[]).push([[94742],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>h});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),c=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=c(e.components);return r.createElement(s.Provider,{value:n},e.children)},m="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),m=c(t),u=a,h=m["".concat(s,".").concat(u)]||m[u]||p[u]||i;return t?r.createElement(h,o(o({ref:n},d),{},{components:t})):r.createElement(h,o({ref:n},d))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[m]="string"==typeof e?e:a,o[1]=l;for(var c=2;c<i;c++)o[c]=t[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},31981:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=t(87462),a=(t(67294),t(3905));const i={title:"Performance & Tracing Update",slug:"2024-09-23-performance-and-tracing",authors:"mgmeier",tags:["performance-tracing"],hide_table_of_contents:!1},o=void 0,l={permalink:"/2024-09-23-performance-and-tracing",editUrl:"https://github.com/intersectmbo/cardano-updates/tree/main/blog/2024-09-23-performance-and-tracing.md",source:"@site/blog/2024-09-23-performance-and-tracing.md",title:"Performance & Tracing Update",description:"High level summary",date:"2024-09-23T00:00:00.000Z",formattedDate:"September 23, 2024",tags:[{label:"performance-tracing",permalink:"/tags/performance-tracing"}],readingTime:3.625,hasTruncateMarker:!1,authors:[{name:"Michael Karg",title:"Performance and Tracing Team Lead",url:"https://github.com/mgmeier",imageURL:"https://github.com/mgmeier.png",key:"mgmeier"}],frontMatter:{title:"Performance & Tracing Update",slug:"2024-09-23-performance-and-tracing",authors:"mgmeier",tags:["performance-tracing"],hide_table_of_contents:!1},prevItem:{title:"Mithril Team Update",permalink:"/2024-09-25-mithril"},nextItem:{title:"SRE Team Update",permalink:"/2024-09-20-sre"}},s={authorsImageUrls:[void 0]},c=[{value:"High level summary",id:"high-level-summary",level:2},{value:"Low level overview",id:"low-level-overview",level:2},{value:"Benchmarking",id:"benchmarking",level:3},{value:"Development - New Tracing System",id:"development---new-tracing-system",level:3},{value:"Workbench",id:"workbench",level:3},{value:"Infrastructure",id:"infrastructure",level:3},{value:"Tracing",id:"tracing",level:3}],d={toc:c},m="wrapper";function p(e){let{components:n,...t}=e;return(0,a.kt)(m,(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"high-level-summary"},"High level summary"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Benchmarking: Release benchmarks for Node ",(0,a.kt)("inlineCode",{parentName:"li"},"9.2.0"),'. Validating the new "age of Voltaire" performance baseline.'),(0,a.kt)("li",{parentName:"ul"},"Development - New Tracing System: A space leak in the forwarding mechanism was fixed; a log rotation bug is being investigated."),(0,a.kt)("li",{parentName:"ul"},"Workbench: Large refactoring of ",(0,a.kt)("inlineCode",{parentName:"li"},"workbench"),", optimizing nix closure size and adding profile flake outputs. Adjusted Nomad backend was merged."),(0,a.kt)("li",{parentName:"ul"},"Infrastructure: Dropping ",(0,a.kt)("inlineCode",{parentName:"li"},"Vault")," for the Nomad cluster was tested and merged."),(0,a.kt)("li",{parentName:"ul"},"Tracing: Further metrics names alignment; be OpenMetrics specs compliant; adding annotations to Prometheus metrics; internal monitoring servers routing has entered testing.")),(0,a.kt)("h2",{id:"low-level-overview"},"Low level overview"),(0,a.kt)("h3",{id:"benchmarking"},"Benchmarking"),(0,a.kt)("p",null,"We've run and analyzed a full set of release benchmarks for Node version ",(0,a.kt)("inlineCode",{parentName:"p"},"9.2.0"),". In comparison with Mainnet release ",(0,a.kt)("inlineCode",{parentName:"p"},"9.1.1"),", we could not observe any performance regression.  "),(0,a.kt)("p",null,'Moreover, we\'ve validated the stability of our new "age of Voltaire" performance baseline on ',(0,a.kt)("inlineCode",{parentName:"p"},"9.1.1"),". Currently, we're running a cross-comparison between baselines and Node versions ",(0,a.kt)("inlineCode",{parentName:"p"},"9.1.1")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"9.2.0")," to ascertain that\nthe new baseline arrives - at scale - at the same performance observations and predictions as the previous one."),(0,a.kt)("h3",{id:"development---new-tracing-system"},"Development - New Tracing System"),(0,a.kt)("p",null,"Forwarding traces and metrics in the new system exhibited a tiny space leak. Under conventional operation, this leak would only become noticeable after running uninterrupted for days or even weeks. It took very hard pressure on the\nsystem, and additional profiling, to make it visible. It could be fixed by avoiding unnecessary allocations of continuations: The buffer of objects to forward inherently carries the position of the next object to process, such that a fully\nevaluated closure can trivially be reused to handle any subsequent forwarding request. This has led to new versions of packages ",(0,a.kt)("inlineCode",{parentName:"p"},"trace-foward-2.2.7")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"ekg-forward-0.6"),". Huge thanks to John Lotoski and Javier Sagredo, whose\nmeticulous information helped to swiftly address the issue.  "),(0,a.kt)("p",null,"On the benchmarking cluster, we've observed ",(0,a.kt)("inlineCode",{parentName:"p"},"cardano-tracer"),"'s log rotation to occasionally misbehave: under certain circumstances, the service leaks handles by not redirecting output to the latest log file in the rotation. We've located the\nissue and are working towards a fix."),(0,a.kt)("h3",{id:"workbench"},"Workbench"),(0,a.kt)("p",null,"We've been working on a major refactoring of ",(0,a.kt)("inlineCode",{parentName:"p"},"workbench")," code. The main benefit of this endeavour is being able to pull in a very heavy dependency optionally only when required, when building and running the ",(0,a.kt)("inlineCode",{parentName:"p"},"workbench")," shell. This will especially facilitate runs on CI machines after garbage collections, but also building a local shell on individual developer machines. Additionally, benchmarking profiles designed for the cluster are now provided as nix flake outputs. This allows for building a more versatile automation in the future, where ",(0,a.kt)("inlineCode",{parentName:"p"},"workbench")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"cardano-node")," commits won't need to be tied to each other. Last not least, the refactoring simplified the way the shell commands are evaluated, doing away with nested calls in many instances. The refactoring PR has been thouroughly tested and merged."),(0,a.kt)("p",null,"Furthermore, the workbench is now prepared for a ",(0,a.kt)("inlineCode",{parentName:"p"},"nixpkgs")," upgrade and has dropped the container-based Nomad / ",(0,a.kt)("inlineCode",{parentName:"p"},"podman")," backend - the respective PR was merged successfully.  "),(0,a.kt)("h3",{id:"infrastructure"},"Infrastructure"),(0,a.kt)("p",null,"Removal of the ",(0,a.kt)("inlineCode",{parentName:"p"},"Vault")," service for managing benchmarking cluster credentials has been successfully tested and merged. The service is scheduled for final shutdown end of month, reducing hardware cost and maintenance effort."),(0,a.kt)("h3",{id:"tracing"},"Tracing"),(0,a.kt)("p",null,"We've received initial feedback regarding the alignment of metrics names between new and legacy tracing systems. Based upon that feedback, we're currently working on some further adjustments to the naming schema.    "),(0,a.kt)("p",null,"The implementation for hosting multiple EKG monitors in one single service has been finished and is currently in the testing phase. The dynamic routing to monitoring data, now used both for EKG and Prometheus, reflects the nodes that are connected to ",(0,a.kt)("inlineCode",{parentName:"p"},"cardano-tracer"),". We've also added a JSON response format, which makes it easier to query and scrape existing routes as part of automations. Finally, this PR also removes the dependency on the ",(0,a.kt)("inlineCode",{parentName:"p"},"snap")," server framework and transitively on ",(0,a.kt)("inlineCode",{parentName:"p"},"HsOpenSSL")," (which is prone to cause build issues in the future).  "),(0,a.kt)("p",null,"Currently, we're working on various improvements to the Prometheus metric expositions in ",(0,a.kt)("inlineCode",{parentName:"p"},"cardano-tracer"),". We aim to implement full compliance with the OpenMetrics specification, which should greatly enhance integration processes. Furthermore, metrics\nwill be augmented with ",(0,a.kt)("inlineCode",{parentName:"p"},"# TYPE")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"# HELP")," annotations, as tracked in issue ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/IntersectMBO/cardano-node/issues/5140"},"cardano-node#5021"),"."),(0,a.kt)("p",null,"Last not least, we've closed off issue ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/IntersectMBO/cardano-node/issues/3988"},"cardano-node#3988"),". For adding an optional prefix to metrics names, the Node config option ",(0,a.kt)("inlineCode",{parentName:"p"},"TraceOptionMetricsPrefix")," can now be used. "))}p.isMDXComponent=!0}}]);