"use strict";(self.webpackChunkcardano_updates=self.webpackChunkcardano_updates||[]).push([[63489],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),c=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return r.createElement(s.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=c(n),u=a,h=p["".concat(s,".").concat(u)]||p[u]||m[u]||o;return n?r.createElement(h,i(i({ref:t},d),{},{components:n})):r.createElement(h,i({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:a,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},76190:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var r=n(87462),a=(n(67294),n(3905));const o={title:"Performance & Tracing Update",slug:"2025-02-03-performance-and-tracing",authors:"mgmeier",tags:["performance-tracing"],hide_table_of_contents:!1},i=void 0,l={permalink:"/2025-02-03-performance-and-tracing",editUrl:"https://github.com/intersectmbo/cardano-updates/tree/main/blog/2025-02-03-performance-and-tracing.md",source:"@site/blog/2025-02-03-performance-and-tracing.md",title:"Performance & Tracing Update",description:"High level summary",date:"2025-02-03T00:00:00.000Z",formattedDate:"February 3, 2025",tags:[{label:"performance-tracing",permalink:"/tags/performance-tracing"}],readingTime:3.975,hasTruncateMarker:!1,authors:[{name:"Michael Karg",title:"Performance and Tracing Team Lead",url:"https://github.com/mgmeier",imageURL:"https://github.com/mgmeier.png",key:"mgmeier"}],frontMatter:{title:"Performance & Tracing Update",slug:"2025-02-03-performance-and-tracing",authors:"mgmeier",tags:["performance-tracing"],hide_table_of_contents:!1},prevItem:{title:"Hydra Team Update",permalink:"/2025-02-04-hydra"},nextItem:{title:"SRE Team Update",permalink:"/2025-01-31-sre"}},s={authorsImageUrls:[void 0]},c=[{value:"High level summary",id:"high-level-summary",level:2},{value:"Low level overview",id:"low-level-overview",level:2},{value:"Benchmarking",id:"benchmarking",level:3},{value:"Development",id:"development",level:3},{value:"Infrastructure",id:"infrastructure",level:3},{value:"Tracing",id:"tracing",level:3},{value:"Community",id:"community",level:3}],d={toc:c},p="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"high-level-summary"},"High level summary"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Benchmarking: Release benchmarks and performance baselines on ",(0,a.kt)("inlineCode",{parentName:"li"},"10.2")," for UTxO-HD, new GHC, Genesis; 'Perdiodic tracer' benchmarks."),(0,a.kt)("li",{parentName:"ul"},"Development: Pervasive thread labeling in the Node; fix a race condition in monitoring dependency ",(0,a.kt)("inlineCode",{parentName:"li"},"ekg-wai"),"."),(0,a.kt)("li",{parentName:"ul"},"Infrastructure: Haskell profile definition work passed testing, ready for merge; continued 'Byron' support in our tooling."),(0,a.kt)("li",{parentName:"ul"},"Tracing: C library for trace forwarding reached prototype stage; last batch of documentation updates ready for publication."),(0,a.kt)("li",{parentName:"ul"},"Community: Support and valuable feedback on Discord for new tracing system rollout.")),(0,a.kt)("h2",{id:"low-level-overview"},"Low level overview"),(0,a.kt)("h3",{id:"benchmarking"},"Benchmarking"),(0,a.kt)("p",null,"We've performed a full set of release benchmarks and analyses for Node version ",(0,a.kt)("inlineCode",{parentName:"p"},"10.2"),". We could not detect any performance risks, and expect network performance to be equivalent or slightly better\nthan ",(0,a.kt)("inlineCode",{parentName:"p"},"10.1.x")," releases, albeit using slightly more CPU resources under rare conditions."),(0,a.kt)("p",null,"Furthermore, we're building several performance baselines with ",(0,a.kt)("inlineCode",{parentName:"p"},"10.2")," to compare future changes, features or node flavours to. For comparative benchmarks, it's vital every change be measured individually, as to\nbe able to discern their individual performance impact. For Node ",(0,a.kt)("inlineCode",{parentName:"p"},"10.3"),", there are several of those we want to capture, such as crypto class simplifications in Ledger, UTxO-HD with a new in-memory backend,\nOuroboros Genesis, and last not least a new GHC9.6 release addressing a remaining performance blocker when building Cardano.  "),(0,a.kt)("p",null,"Additionally, we've validated the 'Periodic tracer' feature on cluster benchmarks and now have evidence of its positive impact on performance. This feature decorrelates gathering metrics from the ledger\nfrom the start of a block producer's forging loop, without sacrificing predictability of performance. By removing this competition on certain synchronization primitives, the hot code path in the forging\nloop now executes faster. The feature will be integrated in a future version of the Node."),(0,a.kt)("h3",{id:"development"},"Development"),(0,a.kt)("p",null,"We've tracked down a race condition in a community package that both tracing systems depend on for exposing metrics. In ",(0,a.kt)("inlineCode",{parentName:"p"},"ekg-wai"),", a ",(0,a.kt)("inlineCode",{parentName:"p"},"ThreadKilled")," exception could be re-thrown to the thread where\nit originated from. It is a low-risk condition, as it occurs only when then Node process terminates; however, when terminating due to an error condition, it caused the process to end prematurely, before the\nerror could be logged. We've opened a ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/tvh/ekg-wai/pull/12"},"PR (ekg-wai#12)")," against the package containing the fix and pre-released on CHaP.    "),(0,a.kt)("p",null,"Tracking down this condition could have been improved by providing pervasive, human-readable labels for all the threads that the Node process spawns. So in coordination with the Consensus team,\nwe made sure this is the case for future builds of the Node - including locations in the code where dependency packages internally use ",(0,a.kt)("inlineCode",{parentName:"p"},"forkIO")," to create green threads. This will\nenhance usability of debug output when looking into concurrency issues."),(0,a.kt)("h3",{id:"infrastructure"},"Infrastructure"),(0,a.kt)("p",null,"The Haskell definition of benchmarking workloads - and the removal of its ",(0,a.kt)("inlineCode",{parentName:"p"},"bash"),"/",(0,a.kt)("inlineCode",{parentName:"p"},"jq")," counterpart - is complete, and has passed testing phase. This includes a final alignment between all profile content\ndefined using either option. Once merged, this will open up the path for simplification of how ",(0,a.kt)("inlineCode",{parentName:"p"},"nix")," interacts with the performance ",(0,a.kt)("inlineCode",{parentName:"p"},"workbench")," - and hopefully reduce complexity for our CI runners.  "),(0,a.kt)("p",null,"As ",(0,a.kt)("inlineCode",{parentName:"p"},"cardano-api")," is deprecating some protocol parameter related data types which do not have relevance for Cardano anymore, we've had a discussion with stakeholders about the implications for our tooling:\nThis would effectively disable our ability to benchmark clusters of BFT nodes which do not use a staking / reward-based consensus algorithm - as it used to be in Cardano's Byron era. The decision\nwas made to not drop that ability from our tooling, as there are potential applications for the benchmarks outside of Cardano. As a consequence, we've startied porting those types to live on in our toolchain,\nrepresenting an additonal maintenance item within our team."),(0,a.kt)("h3",{id:"tracing"},"Tracing"),(0,a.kt)("p",null,"The self-contained C library implementing trace forwarding is now in prototype state. It contains a pure C implementation of our forwarding protocol over socket,\nas well as pure C CBOR codecs for data payload to match the ",(0,a.kt)("inlineCode",{parentName:"p"},"TraceObject")," schema used within the context Cardano. That ensures existing tooling can process traces emitted\nby non-Cardano applications, written in languages other than Haskell.  "),(0,a.kt)("p",null,"The latest updates to ",(0,a.kt)("a",{parentName:"p",href:"https://developers.cardano.org/docs/get-started/cardano-node/new-tracing-system/cardano-tracer"},"Developer Portal: ",(0,a.kt)("inlineCode",{parentName:"a"},"cardano-tracer"))," are ready to be published and awaiting a PR review on the Cardano Developer Portal."),(0,a.kt)("h3",{id:"community"},"Community"),(0,a.kt)("p",null,"We've been quite busy on our new Discord channel ",(0,a.kt)("a",{parentName:"p",href:"https://discord.com/channels/826816523368005654/1332375957528514590"},(0,a.kt)("em",{parentName:"a"},"#tracing-monitoring"))," on the ",(0,a.kt)("em",{parentName:"p"},"IOG's Technical Community")," server. There's been\nan initial spike of interest and we've been able to provide support and explain various design decisions of the new tracing system. Additionally, we've gotten valuable feedback about potential\nfeatures that would greatly help adoption of the new system. These are typically highly localized in their implementation, and non-breaking wrt. to API and design, such that addressing this\nfeedback promptly adds much value at low risk - Thank You for your input!"))}m.isMDXComponent=!0}}]);